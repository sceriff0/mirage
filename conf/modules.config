/*
========================================================================================
    Process-specific Resource Configuration
========================================================================================
    Direct SLURM resource allocation for each process
========================================================================================
*/

process {

    /*
    ================================================================================
        Resource Labels (used by processes)
    ================================================================================
    */

    /*
    ================================================================================
        Default Publishing Settings
    ================================================================================
    */

    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].toLowerCase()}" },
        mode: 'copy',
        saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
    ]

    /*
    ================================================================================
        Resource Labels (used by processes)
    ================================================================================
    */

    withLabel: 'process_single' {
        cpus   = { check_max( 1                  , 'cpus'   ) }
        memory = { check_max( 6.GB * task.attempt, 'memory' ) }
        time   = { check_max( 4.h  * task.attempt, 'time'   ) }
    }

    withLabel: 'process_low' {
        cpus   = { check_max( 2     * task.attempt, 'cpus'   ) }
        memory = { check_max( 12.GB * task.attempt, 'memory' ) }
        time   = { check_max( 4.h   * task.attempt, 'time'   ) }
    }

    withLabel: 'process_medium' {
        cpus   = { check_max( 8     * task.attempt, 'cpus'   ) }
        memory = { check_max( 150.GB * task.attempt, 'memory' ) }
        time   = { check_max( 8.h   * task.attempt, 'time'   ) }
    }

    withLabel: 'process_high' {
        cpus   = { check_max( 12    * task.attempt, 'cpus'   ) }
        memory = { check_max( 256.GB * task.attempt, 'memory' ) }
        time   = { check_max( 16.h  * task.attempt, 'time'   ) }
    }

    withLabel: 'process_long' {
        time   = { check_max( 48.h  * task.attempt, 'time'   ) }
    }

    withLabel: 'process_high_memory' {
        memory = { check_max( 400.GB * task.attempt, 'memory' ) }
    }

    withLabel: 'gpu' {
        clusterOptions = '--gres=gpu:1'
        containerOptions = '--nv'  // Enable NVIDIA GPU support in Singularity
    }

    withLabel: 'error_ignore' {
        errorStrategy = 'ignore'
    }

    withLabel: 'error_retry' {
        errorStrategy = 'retry'
        maxRetries    = 3
    }

    /*
    ================================================================================
        Pipeline Processes
    ================================================================================
    */

    withName: 'CONVERT_IMAGE' {
        ext.args = ''
        publishDir = [
            path: { "${params.outdir}/${meta.patient_id}/${params.registration_method}/converted" },
            mode: 'copy',
            pattern: "*.{ome.tif,txt}"
        ]
    }

    withName: 'PREPROCESS' {
        ext.args = ''
        publishDir = [
            [
                path: { "${params.outdir}/${meta.patient_id}/${params.registration_method}/preprocessed" },
                mode: 'copy',
                pattern: "*_corrected.ome.tif"
            ],
            [
                path: { "${params.outdir}/${meta.patient_id}/${params.registration_method}/preprocessed/dims" },
                mode: 'copy',
                pattern: "*_dims.txt",
                enabled: false
            ]
        ]
    }

    withName: 'MAX_DIM' {
        cpus   = 1
        memory = '8.GB'
        time   = '10.m'
    }

    withName: 'REGISTER' {
        cpus   = 16
        memory = '512.GB'
        time   = '48.h'
    }
/*
    withName: 'GPU_REGISTER' {
        // Dynamic resources defined in process (based on file size)
        // Memory: Small (<10GB) = 128GB, Medium (10-30GB) = 256GB, Large (>30GB) = 388GB
        // Time: Small = 2h, Medium = 3h, Large = 4h
        // CPU and GPU allocation handled in process definition
    }
*/
    withName: 'MERGE' {
        cpus   = 4
        memory = '512.GB'
        time   = '8.h'
    }

    withName: 'SEGMENT' {
        cpus   = 8
        memory = '450.GB'
        time   = '4.h'
        // Automatically adds GPU based on params.seg_gpu
        clusterOptions = { params.seg_gpu ? '--gres=gpu:nvidia_h200:1' : '' }
    }

    withName: 'CLASSIFY' {
        cpus   = 4
        memory = '256.GB'
        time   = '3.h'
        // Automatically adds GPU based on params.classify_gpu
        clusterOptions = { params.classify_gpu ? '--gres=gpu:nvidia_h200:1' : '' }
    }

    withName: 'QUANTIFY' {
        cpus   = 8
        memory = '200.GB'
        time   = '12.h'
        // Automatically adds GPU based on params.quant_gpu
        //clusterOptions = { params.quant_gpu ? '--gres=gpu:nvidia_h200:1' : '' }
    }

    withName: 'PHENOTYPE' {
        cpus   = 4
        memory = '64.GB'
        time   = '2.h'
    }

    withName: 'CREATE_PYRAMID' {
        cpus   = 4
        memory = '256.GB'
        time   = '4.h'
    }
}

