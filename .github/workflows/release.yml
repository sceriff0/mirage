name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string

env:
  NFTEST_VERSION: '0.9.0'

jobs:
  # ============================================================================
  # Validate release
  # ============================================================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Validate version format
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if ! [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid version format: $VERSION"
            echo "Expected format: vX.Y.Z (e.g., v1.0.0)"
            exit 1
          fi

      - name: Check version in nextflow.config
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          VERSION_NO_V="${VERSION#v}"
          CONFIG_VERSION=$(grep "version" nextflow.config | head -1 | grep -oP "'\K[^']+")

          echo "Tag version: $VERSION_NO_V"
          echo "Config version: $CONFIG_VERSION"

          if [ "$CONFIG_VERSION" != "$VERSION_NO_V" ]; then
            echo "::warning::Version mismatch - config has $CONFIG_VERSION but tag is $VERSION"
          fi

  # ============================================================================
  # Run full test suite
  # ============================================================================
  test:
    name: Full Test Suite
    needs: validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Nextflow
        uses: actions/cache@v4
        with:
          path: ~/.nextflow
          key: ${{ runner.os }}-nextflow-release-${{ hashFiles('**/*.nf') }}
          restore-keys: |
            ${{ runner.os }}-nextflow-

      - name: Install Nextflow
        uses: nf-core/setup-nextflow@v2
        with:
          version: 'latest-everything'

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install numpy tifffile pytest

      - name: Generate test data
        run: |
          python tests/testdata/generate_complete_testdata.py

      - name: Install nf-test
        run: |
          curl -fsSL https://code.askimed.com/install/nf-test | bash
          sudo mv nf-test /usr/local/bin/

      - name: Run Python tests
        run: |
          pytest -v tests/ --ignore=tests/testdata --ignore=tests/modules --ignore=tests/subworkflows || true

      - name: Run validation tests
        run: |
          bash tests/run_validation_tests.sh || echo "Validation completed"

      - name: Run pipeline stub tests
        run: |
          nextflow run . \
            -profile test,docker \
            -stub \
            --outdir test_results_stub

      - name: Run nf-test suite
        run: |
          nf-test test --profile test,docker

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-test-results
          path: |
            test_results_stub/
            .nf-test/
            .nextflow.log

  # ============================================================================
  # Create release artifacts
  # ============================================================================
  artifacts:
    name: Create Artifacts
    needs: [validate, test]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create release archive
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          ARCHIVE_NAME="mirage-${VERSION}.tar.gz"

          # Create archive excluding development files
          tar --exclude='.git' \
              --exclude='.github' \
              --exclude='.nf-test' \
              --exclude='work' \
              --exclude='test_results*' \
              --exclude='*.log' \
              --exclude='__pycache__' \
              --exclude='.pytest_cache' \
              -czvf "$ARCHIVE_NAME" .

          echo "Created archive: $ARCHIVE_NAME"
          ls -lh "$ARCHIVE_NAME"

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-archive
          path: mirage-*.tar.gz

  # ============================================================================
  # Update release notes
  # ============================================================================
  release-notes:
    name: Update Release Notes
    needs: [validate, test, artifacts]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download release archive
        uses: actions/download-artifact@v4
        with:
          name: release-archive

      - name: Upload archive to release
        uses: softprops/action-gh-release@v1
        with:
          files: mirage-*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update release body
        uses: softprops/action-gh-release@v1
        with:
          body: |
            ## MIRAGE Pipeline Release ${{ needs.validate.outputs.version }}

            ### Installation

            ```bash
            # Clone the repository
            git clone https://github.com/${{ github.repository }}.git
            cd mirage

            # Or download the release archive
            wget https://github.com/${{ github.repository }}/releases/download/${{ needs.validate.outputs.version }}/mirage-${{ needs.validate.outputs.version }}.tar.gz
            ```

            ### Quick Start

            ```bash
            nextflow run . -profile test,docker --outdir results
            ```

            ### Requirements

            - Nextflow >= 23.04.0
            - Docker or Singularity

            ---

            *This release was automatically tested and packaged by GitHub Actions.*
          append_body: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
