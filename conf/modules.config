/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Module-specific configuration for SLURM execution
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Direct resource allocation without check_max wrappers
*/

process {

    //
    // Process label definitions for SLURM
    //
    withLabel: 'process_low' {
        cpus   = 2
        memory = '4.GB'
        time   = '1.h'
    }

    withLabel: 'process_medium' {
        cpus   = 4
        memory = '16.GB'
        time   = '4.h'
    }

    withLabel: 'process_high' {
        cpus   = 8
        memory = '32.GB'
        time   = '8.h'
    }

    withLabel: 'gpu' {
        cpus   = 8
        memory = '64.GB'
        time   = '12.h'
        clusterOptions = '--gres=gpu:1'
    }

    //
    // Process-specific resource configuration
    //
    withName: 'PREPROCESS' {
        cpus   = 4
        memory = '16.GB'
        time   = '2.h'
    }

    withName: 'REGISTER' {
        cpus   = 8
        memory = '32.GB'
        time   = '4.h'
    }

    withName: 'SEGMENT' {
        cpus   = 8
        memory = '32.GB'
        time   = '6.h'
        // Automatically adds GPU if params.seg_gpu = true
        clusterOptions = { params.seg_gpu ? '--gres=gpu:1' : '' }
    }

    withName: 'QUANTIFY' {
        cpus   = 4
        memory = '16.GB'
        time   = '4.h'
        // Automatically adds GPU if params.quant_gpu = true
        clusterOptions = { params.quant_gpu ? '--gres=gpu:1' : '' }
    }

    withName: 'PHENOTYPE' {
        cpus   = 4
        memory = '16.GB'
        time   = '2.h'
    }

    //
    // Legacy process resource overrides (if still used)
    //
    withName: 'apply_padding' {
        memory = params.test ? '8.GB' : '50.GB'
        time   = '2.h'
    }

    withName: 'affine' {
        memory = params.test ? '5.GB' : '70.GB'
        time   = '4.h'
    }

    withName: 'diffeomorphic' {
        memory = '50.GB'
        time   = '6.h'
        clusterOptions = '--array=0-50'
    }

    withName: 'stitching' {
        memory = params.test ? '5.GB' : '60.GB'
        time   = '3.h'
    }

    withName: 'quality_control' {
        memory = params.test ? '20.GB' : '60.GB'
        time   = '2.h'
    }

    withName: 'stacking' {
        memory = params.test ? '5.GB' : '60.GB'
        time   = '2.h'
    }
}
