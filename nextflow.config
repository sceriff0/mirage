/*
========================================================================================
    ATEIA WSI Processing Pipeline - Main Configuration
========================================================================================
    Author: ateia team
    Version: 0.1.0
========================================================================================
*/

// Include modular configurations
includeConfig 'conf/base.config'
includeConfig 'conf/modules.config'

// Pipeline metadata
manifest {
    name            = 'ateia'
    description     = 'WSI processing pipeline (preprocessing, registration, segmentation, quantification, phenotyping)'
    author          = 'ateia team'
    version         = '0.1.0'
    nextflowVersion = '>=23.04.0'
}

/*
========================================================================================
    Pipeline Parameters
========================================================================================
*/

params {
    // ============================================================================
    // Input/Output
    // ============================================================================
    input       = ""              // Input glob pattern (e.g., "data/*.nd2")
    outdir      = "./results"     // Output directory

    // ============================================================================
    // SLURM Configuration
    // ============================================================================
    slurm_partition = null        // SLURM partition name (null = default)
    slurm_account   = null        // SLURM account (null = not set)
    slurm_qos       = null        // Quality of Service (null = not set)

    // ============================================================================
    // Preprocessing Parameters
    // ============================================================================
    preproc_normalize    = true
    preproc_tile_size    = 512
    preproc_skip_dapi    = true
    preproc_autotune     = false
    preproc_n_iter       = 3
    preproc_pool_workers = 4
    preproc_overlap      = 0                 // Overlap between FOV tiles for BaSiC
    preproc_no_darkfield = false             // Disable darkfield estimation

    // ============================================================================
    // Registration Parameters
    // ============================================================================
    reg_reference_markers     = ['DAPI', 'SMA']  // Markers to identify reference image
    reg_max_processed_dim     = 1800             // Maximum image dimension for rigid registration
    reg_max_non_rigid_dim     = 3600            // Maximum dimension for non-rigid registration
    reg_micro_reg_fraction    = 0.25             // Fraction of image size for micro-registration
    reg_num_features          = 2000             // Number of SuperPoint features to detect

    // ============================================================================
    // Segmentation Parameters
    // ============================================================================
    seg_model              = 'cellpose'
    seg_gpu                = true
    seg_whole_image        = true
    seg_crop_size          = 8000
    seg_gamma              = 0.6
    seg_tophat_radius      = 50                // Top-hat morphological filter radius
    seg_gaussian_sigma     = 1.0               // Gaussian filter sigma for smoothing
    seg_pmin               = 1.0               // Normalization lower percentile
    seg_pmax               = 99.8              // Normalization upper percentile
    segmentation_overlap   = 2500
    segmentation_model_dir = "/hpcnfs/scratch/P_DIMA_ATTEND/models/"
    segmentation_model     = "stardist_full_e200_lr00001_aug1_seed10_es50p0.001_rlr0.5p50"

    // ============================================================================
    // Cell Classification Parameters (deepcell-types)
    // ============================================================================
    classify_gpu         = true                          // Use GPU for classification
    classify_model       = 'deepcell-types_2025-06-09'   // DeepCell Types model name
    classify_num_workers = 4                             // Number of data loader threads

    // ============================================================================
    // Pipeline Control
    // ============================================================================
    test = false

    // ============================================================================
    // General
    // ============================================================================
    threads = 4
}

/*
========================================================================================
    Container Images
========================================================================================
*/

params.container = [
    preprocess:     'docker://alech00/attend_image_analysis:v2.1',
    registration:   'docker://cdgatenbee/valis-wsi:1.1.0',
    segmentation:   'docker.io/ateia/segment:latest',
    classify:       'docker.io/ateia/classify:latest'
]

/*
========================================================================================
    Execution Profiles
========================================================================================
*/

profiles {
    // Default: SLURM execution with Singularity containers
    standard {
        process.executor = 'slurm'
        process.queue    = params.slurm_partition
        process.container = "alech00/attend_image_analysis:v2.1"

        singularity.enabled    = true
        singularity.autoMounts = true
        docker.enabled         = false

        process.clusterOptions = {
            def opts = []
            if (params.slurm_account && params.slurm_account != '') opts << "--account=${params.slurm_account}"
            if (params.slurm_qos && params.slurm_qos != '')         opts << "--qos=${params.slurm_qos}"
            return opts ? opts.join(' ') : null
        }
    }

    // SLURM with Singularity containers (alias for standard)
    slurm {
        process.executor = 'slurm'
        process.queue    = params.slurm_partition
        process.container = "alech00/attend_image_analysis:v2.1"

        singularity.enabled    = true
        singularity.autoMounts = true
        docker.enabled         = false

        process.clusterOptions = {
            def opts = []
            if (params.slurm_account && params.slurm_account != '') opts << "--account=${params.slurm_account}"
            if (params.slurm_qos && params.slurm_qos != '')         opts << "--qos=${params.slurm_qos}"
            return opts ? opts.join(' ') : null
        }
    }

    // Test profile (small dataset validation)
    test {
        params.test = true
        includeConfig 'conf/test.config'
    }

    // Local development (no SLURM)
    local {
        process.executor = 'local'
        process.cpus     = 4
        process.memory   = '16.GB'
    }

    // Docker (local development with containers)
    docker {
        process.executor  = 'local'
        docker.enabled    = true
        docker.runOptions = '-u $(id -u):$(id -g)'
    }
}

/*
========================================================================================
    Nextflow Tower (optional monitoring)
========================================================================================
*/

tower {
    accessToken = 'eyJ0aWQiOiA2NX0uMWQ3ODE3OGZjYzNmZWJiOTdjYWI3N2QwZDQwNjFiZWExODZmNDhkNQ=='
    workspaceId = '61664385669434'
    enabled  = true
    endpoint = 'https://seqera.ieo.it/api'
}
