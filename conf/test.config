/*
========================================================================================
    Test Profile Configuration - nf-core Compliant
========================================================================================
    Minimal test dataset to check pipeline function
    Reference: https://nf-co.re/docs/guidelines/pipelines/recommendations/testing
========================================================================================
*/

params {
    config_profile_name        = 'Test profile'
    config_profile_description = 'Minimal test dataset to check pipeline function'

    // Limit resources for CI/local testing
    max_cpus   = 2
    max_memory = '6.GB'
    max_time   = '1.h'

    // Test input data (relative to pipeline root)
    input  = "${projectDir}/tests/testdata/test_input.csv"
    outdir = "test_results"

    // Pipeline step
    step = 'preprocessing'

    // Skip ND2 conversion for test data (already in OME-TIFF format)
    skip_nd2_conversion = true

    // Disable GPU for CI testing
    seg_gpu    = false
    quant_gpu  = false
    gpu_register = false

    // Reduce computational requirements for fast testing
    preproc_tile_size         = 256
    preproc_n_iter            = 1
    preproc_pool_workers      = 2

    // Registration parameters for minimal data
    registration_method       = 'valis'
    padding                   = false
    reg_max_processed_dim     = 256
    reg_max_non_rigid_dim     = 512
    feature_max_dim           = 512
    feature_n_features        = 500

    // GPU registration parameters (reduced for testing)
    gpu_reg_affine_crop_size  = 1000
    gpu_reg_diffeo_crop_size  = 500

    // CPU registration parameters (reduced for testing)
    cpu_reg_affine_crop_size  = 1000
    cpu_reg_diffeo_crop_size  = 500

    // Segmentation parameters (minimal tiling)
    seg_n_tiles_y             = 2
    seg_n_tiles_x             = 2
    seg_tile_size             = 512
    seg_overlap               = 64

    // QC generation (enabled but minimal)
    skip_registration_qc      = false
    qc_scale_factor           = 0.1

    // Error estimation (disabled for speed)
    enable_feature_error      = false
    enable_segmentation_error = false

    // Phenotyping (minimal thresholds)
    pheno_n_neighbors         = 5

    // Disable expensive operations
    cleanup_work              = false
    savedir                   = null
}

process {
    // Local executor for testing
    executor = 'local'

    // Default minimal resources
    cpus   = { check_max( 1, 'cpus' ) }
    memory = { check_max( 2.GB, 'memory' ) }
    time   = { check_max( 30.m, 'time' ) }

    // Resource labels for testing
    withLabel: 'process_single' {
        cpus   = 1
        memory = 2.GB
        time   = 15.m
    }

    withLabel: 'process_low' {
        cpus   = 1
        memory = 2.GB
        time   = 30.m
    }

    withLabel: 'process_medium' {
        cpus   = 2
        memory = 4.GB
        time   = 1.h
    }

    withLabel: 'process_high' {
        cpus   = 2
        memory = 6.GB
        time   = 1.h
    }

    withLabel: 'gpu' {
        // Override GPU processes to run on CPU for testing
        cpus   = 2
        memory = 4.GB
        time   = 1.h
    }

    // Error handling for CI
    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries    = 1
    maxErrors     = '-1'
}

// Container settings - will be overridden by profile (docker/singularity)
// Don't hardcode docker.enabled here to allow singularity profile to work
