/*
========================================================================================
    ATEIA WSI Processing Pipeline - Main Configuration
========================================================================================
    Author: ateia team
    Version: 0.1.0
========================================================================================
*/

// Include modular configurations
includeConfig 'conf/base.config'
includeConfig 'conf/modules.config'

// Pipeline metadata
manifest {
    name            = 'ateia'
    description     = 'WSI processing pipeline (preprocessing, registration, segmentation, quantification, phenotyping)'
    author          = 'ateia team'
    version         = '0.1.0'
    nextflowVersion = '>=23.04.0'
    mainScript      = 'main.nf'
}

/*
========================================================================================
    Resource Limit Functions
========================================================================================
*/

// Function to ensure resources don't exceed maximum limits
def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "WARNING: Max memory '${params.max_memory}' is not valid"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "WARNING: Max time '${params.max_time}' is not valid"
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min(obj, params.max_cpus as int)
        } catch (all) {
            println "WARNING: Max cpus '${params.max_cpus}' is not valid"
            return obj
        }
    }
}

/*
========================================================================================
    Pipeline Parameters
========================================================================================
*/

params {
    // ============================================================================
    // Input/Output
    // ============================================================================
    input       = ""              // Input glob pattern (e.g., "data/*.nd2") or checkpoint CSV
    outdir      = "./results"     // Output directory
    savedir     = "/hpcnfs/techunits/imaging/work/ATTEND/full_analysis"

    // ============================================================================
    // Pipeline Restart Capability
    // ============================================================================
    step        = 'preprocessing' // Pipeline entry point:
                                  //   'preprocessing'  - Start from raw images (default)
                                  //   'registration'   - Resume from preprocessed.csv
                                  //   'postprocessing' - Resume from registered.csv
                                  //   'results'        - Resume from postprocessed.csv
                                  //   'copy_results'   - Only copy outdir to savedir (no processing)

    // ============================================================================
    // SLURM Configuration
    // ============================================================================
    slurm_partition = null        // SLURM partition name (null = default)
    slurm_account   = null        // SLURM account (null = not set)
    slurm_qos       = null        // Quality of Service (null = not set)
    gpu_type        = 'nvidia_h200:1'  // GPU type for GPU processes (can override per-cluster)

    // ============================================================================
    // Preprocessing Parameters
    // ============================================================================
    preproc_tile_size    = 1950
    preproc_skip_dapi    = true
    preproc_autotune     = false           // Enable BaSiC autotuning
    preproc_n_iter       = 100            // Number of BaSiC iterations
    preproc_pool_workers = 4
    preproc_overlap      = 0                 // Overlap between FOV tiles for BaSiC
    preproc_no_darkfield = false             // Disable darkfield estimation

    // ============================================================================
    // Registration Parameters
    // ============================================================================
    registration_method       = 'valis'       // Registration method: 'valis', 'gpu', or 'cpu'
    padding                   = false       // Enable padding to uniform dimensions per patient before registration

    // QC Generation (method-independent)
    skip_registration_qc      = false       // Skip registration QC generation
    qc_scale_factor           = 0.25        // Downsampling factor for QC PNG outputs (0.25 = 25% of original size)
    preprocess_qc_scale_factor = 0.25       // Downsampling factor for preprocessing QC PNG outputs

    // Classic registration (VALIS)
    reg_reference_markers     = ['DAPI', 'FITC']  // Markers to identify reference image
    reg_max_processed_dim     = 512           // Maximum image dimension for rigid registration
    reg_max_non_rigid_dim     = 2048           // Maximum dimension for non-rigid registration
    reg_micro_reg_fraction    = 0.125            // Fraction of image size for micro-registration
    reg_num_features          = 5000           // Number of SuperPoint features to detect
    reg_max_image_dim         = 4000           // Maximum image dimension for caching (force disk-based processing for WSIs >4000px)
    skip_micro_registration   = true         // Skip micro-rigid registration step
    reg_parallel_warping      = false         // Enable parallel slide warping using ThreadPoolExecutor
    reg_n_workers             = 8              // Number of parallel workers for warping
    reg_use_tiled_registration = true        // Use NonRigidTileRegistrar for large images (parallel tile processing)
    reg_tile_size             = 2048           // Tile size for tiled registration

    // Feature detection and error estimation (for all registration methods)
    feature_detector          = 'superpoint'   // Feature detector: 'superpoint', 'disk', 'dedode', or 'brisk'
    feature_max_dim           = 2048           // Maximum image dimension for feature detection
    feature_n_features        = 5000           // Number of features to keep for matching

    // Error estimation (optional quality metrics after registration)
    enable_feature_error      = false          // Enable feature-based distance measurement (before/after registration)
    enable_segmentation_error = false          // Enable segmentation-based overlap metrics (IoU/Dice)
    min_nucleus_size          = 100            // Minimum nucleus size for segmentation (pixels)
    max_nucleus_size          = 5000           // Maximum nucleus size for segmentation (pixels)

    // GPU registration (affine + diffeomorphic)
    gpu_reg_affine_crop_size  = 10000           // Size of crops for affine registration stage
    gpu_reg_diffeo_crop_size  = 2000           // Size of crops for diffeomorphic registration stage
    gpu_reg_overlap_percent   = 40.0           // Overlap between crops as percentage (larger overlap with linear blending to reduce tile artifacts)
    gpu_reg_n_features        = 5000           // Number of ORB features for affine registration
    gpu_reg_n_workers         = 8              // Number of parallel CPU workers per GPU process
    gpu_reg_opt_tol           = 1e-6           // Diffeomorphic optimization tolerance (default: 1e-5, recommended: 1e-5 to 1e-7)
    gpu_reg_inv_tol           = 1e-6           // Diffeomorphic inverse tolerance (default: 1e-5)
    gpu_reg_pad_mode          = 'constant'     // Padding mode: 'constant' (zeros), 'edge', 'reflect', 'symmetric'

    // CPU registration (affine + diffeomorphic, multi-threaded)
    cpu_reg_affine_crop_size  = 10000           // Size of crops for affine registration stage
    cpu_reg_diffeo_crop_size  = 2000           // Size of crops for diffeomorphic registration stage (smaller for CPU)
    cpu_reg_overlap_percent   = 40.0           // Overlap between crops as percentage (larger overlap with linear blending to reduce tile artifacts)
    cpu_reg_n_features        = 5000           // Number of ORB features for affine registration
    cpu_reg_opt_tol           = 1e-6           // Diffeomorphic optimization tolerance (default: 1e-5, recommended: 1e-5 to 1e-7)
    cpu_reg_inv_tol           = 1e-6           // Diffeomorphic inverse tolerance (default: 1e-5)
    cpu_reg_pad_mode          = 'constant'     // Padding mode: 'constant' (zeros), 'edge', 'reflect', 'symmetric'

    // ============================================================================
    // Segmentation Parameters
    // ============================================================================
    seg_gpu                = true
    seg_pmin               = 1.0               // Normalization lower percentile
    seg_pmax               = 99.8              // Normalization upper percentile
    seg_n_tiles_y          = 16                // Number of tiles in Y direction for StarDist
    seg_n_tiles_x          = 16                // Number of tiles in X direction for StarDist
    seg_expand_distance    = 10                // Distance (pixels) to expand nuclei for whole-cell masks
    segmentation_model_dir = "/hpcnfs/scratch/P_DIMA_ATTEND/models/"
    segmentation_model     = "stardist_full_e200_lr00001_aug1_seed10_es50p0.001_rlr0.5p50"

    // ============================================================================
    // Image Conversion Parameters
    // ============================================================================
    pixel_size           = 0.325                         // Pixel size in microns

    // ============================================================================
    // Quantification Parameters
    // ============================================================================
    quant_gpu            = true                          // Use GPU for quantification
    quant_min_area       = 10                            // Minimum cell area (pixels)

    // ============================================================================
    // Phenotyping Parameters
    // ============================================================================
    pheno_markers            = []                        // Markers to use for phenotyping (empty = all)
    pheno_cutoffs            = []                        // Custom cutoffs for markers
    pheno_quality_percentile = 95                        // Quality control percentile
    pheno_noise_percentile   = 5                         // Noise threshold percentile

    // ============================================================================
    // Pyramid Conversion Parameters
    // ============================================================================
    tilex                = 512                           // Tile width for pyramidal TIFF
    tiley                = 512                           // Tile height for pyramidal TIFF
    pyramid_resolutions  = 3                             // Number of pyramid resolution levels
    pyramid_scale        = 2                             // Scale factor between pyramid levels

    // ============================================================================
    // Pipeline Control
    // ============================================================================
    dry_run = false                    // Run validation only without executing processes
    allow_auto_reference = false       // Allow automatic reference selection if none specified
    cleanup_work = true                // Automatically remove work directory after successful completion

    // ============================================================================
    // Resource Limits
    // ============================================================================
    max_memory       = '700.GB'
    max_cpus         = 64
    max_time         = '240.h'

    // ============================================================================
    // General
    // ============================================================================
    publish_dir_mode = 'copy'
}

/*
========================================================================================
    Container Images
========================================================================================
*/

params.container = [
    preprocess:     'docker://bolt3x/attend_image_analysis:preprocess',
    registration:   'docker://cdgatenbee/valis-wsi:1.0.0',
    register_gpu:   'docker://bolt3x/attend_image_analysis:debug_diffeo', 
    merge:          'docker://bolt3x/attend_image_analysis:merge',
    segmentation:   'docker://bolt3x/attend_image_analysis:segmentation_gpu',
    classify:       'docker://bolt3x/attend_image_analysis:deep_cell_types',
    quantification: 'docker://bolt3x/attend_image_analysis:quantification_gpu'
]

/*
========================================================================================
    Execution Profiles
========================================================================================
*/

profiles {
    // Default: SLURM execution with Singularity containers
    standard {
        process.executor = 'slurm'
        process.queue    = params.slurm_partition
        process.container = "alech00/attend_image_analysis:v2.1"

        singularity.enabled    = true
        singularity.autoMounts = true
        singularity.runOptions = '--writable-tmpfs --bind /hpcnfs/scratch/P_DIMA_ATTEND/models --bind /hpcnfs/home/ieo7660/.deepcell/models --bind /hpcnfs/home/ieo7660/.cupy'
        docker.enabled         = false

        process.clusterOptions = {
            def opts = []
            if (params.slurm_account && params.slurm_account != '') opts << "--account=${params.slurm_account}"
            if (params.slurm_qos && params.slurm_qos != '')         opts << "--qos=${params.slurm_qos}"
            return opts ? opts.join(' ') : null
        }
    }

    // SLURM with Singularity containers (alias for standard)
    slurm {
        process.executor = 'slurm'
        process.queue    = params.slurm_partition
        process.container = "alech00/attend_image_analysis:v2.1"

        singularity.enabled    = true
        singularity.autoMounts = true
        singularity.runOptions = '--writable-tmpfs --bind /hpcnfs/scratch/P_DIMA_ATTEND/models --bind /hpcnfs/home/ieo7660/.deepcell/models'
        docker.enabled         = false

        process.clusterOptions = {
            def opts = []
            if (params.slurm_account && params.slurm_account != '') opts << "--account=${params.slurm_account}"
            if (params.slurm_qos && params.slurm_qos != '')         opts << "--qos=${params.slurm_qos}"
            return opts ? opts.join(' ') : null
        }
    }

    // Test profile (small dataset validation)
    test {
        params.test = true
        includeConfig 'conf/test.config'
    }

    // Local development (no SLURM)
    local {
        process.executor = 'local'
        process.cpus     = 4
        process.memory   = '16.GB'
    }

    // Docker (local development with containers)
    docker {
        process.executor  = 'local'
        docker.enabled    = true
        docker.runOptions = '-u $(id -u):$(id -g)'
        singularity.enabled = false
    }

    // Singularity profile (for HPC without SLURM executor)
    singularity {
        process.executor       = 'slurm'
        singularity.enabled    = true
        singularity.autoMounts = true
        docker.enabled         = false
    }
}

/*
========================================================================================
    Nextflow Tower (optional monitoring)
========================================================================================
*/

tower {
    workspaceId = '61664385669434'
    enabled  = true
    endpoint = 'https://seqera.ieo.it/api'
}
