nextflow_process {

    name "Test QUANTIFY process"
    script "modules/local/quantify.nf"
    process "QUANTIFY"

    tag "modules"
    tag "modules_local"
    tag "quantify"

    test("Should quantify single channel - stub") {

        options "-stub"

        when {
            process {
                """
                input[0] = [
                    [patient_id: 'P001', channels: ['DAPI', 'PANCK', 'SMA']],
                    file('$projectDir/tests/testdata/sample_DAPI.tif', checkIfExists: true),
                    file('$projectDir/tests/testdata/P001_cell_mask.npy', checkIfExists: true)
                ]
                """
            }
        }

        then {
            assert process.success
            assert process.out.individual_csv
            assert process.out.versions

            with(process.out.individual_csv) {
                assert size() == 1
                assert get(0).get(0).patient_id == 'P001'
                assert get(0).get(1).toString().endsWith('_quant.csv')
            }
        }
    }
}

nextflow_process {

    name "Test MERGE_QUANT_CSVS process"
    script "modules/local/quantify.nf"
    process "MERGE_QUANT_CSVS"

    tag "modules"
    tag "modules_local"
    tag "quantify"
    tag "merge_quant"

    test("Should merge multiple channel CSVs - stub") {

        options "-stub"

        when {
            process {
                """
                input[0] = [
                    [patient_id: 'P001', channels: ['DAPI', 'PANCK', 'SMA'], is_reference: true],
                    [
                        file('$projectDir/tests/testdata/sample_DAPI_quant.csv', checkIfExists: true),
                        file('$projectDir/tests/testdata/sample_PANCK_quant.csv', checkIfExists: true),
                        file('$projectDir/tests/testdata/sample_SMA_quant.csv', checkIfExists: true)
                    ]
                ]
                """
            }
        }

        then {
            assert process.success
            assert process.out.merged_csv
            assert process.out.versions

            with(process.out.merged_csv) {
                assert size() == 1
                assert get(0).get(0).patient_id == 'P001'
                assert get(0).get(1).toString().endsWith('merged_quant.csv')
            }
        }
    }
}
