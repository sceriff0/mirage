// Include shared configs used by nf-core-style pipelines
includeConfig 'conf/base.config'
includeConfig 'conf/modules.config'

manifest {
    name = 'ateia'
    description = 'WSI processing pipeline (preprocessing, registration, segmentation, quantification, phenotyping)'
    author = 'ateia team'
    version = '0.1.0'
}

// Default parameters (can be overridden on the CLI)
params {
    // User input parameters.
    input = ""
    outdir = "./results"
    debug_dir = ""
    log_file = ""
    use_gpu = true

    // Max resource limits (nf-core standard)
    max_cpus   = 16
    max_memory = '128.GB'
    max_time   = '240.h'

    // Debug mode.
    debug = true

    // Optional channels.
    optional_channels = ""
    
    preprocessing = true
    conversion = false
    
    // Conversion / preprocessing crop parameters.
    crop_size_preproc = 4096
    overlap_size_preproc = 4000
    crop_size_affine = 10000
    overlap_size_affine = 4000
    crop_size_diffeo = 2000
    overlap_size_diffeo = 800
    downscale_factor = 1
    n_crops = 4

    // Image conversion.
    tilex = 512
    tiley = 512
    pyramid_resolutions = 3
    pyramid_scale = 2
    compression = 'lzw'  // Options: 'lzw', 'jpeg', 'deflate', 'none'
    jpeg_quality = 90    // JPEG quality (1-100), only used if compression='jpeg'

    // Segmentation.
    segmentation_overlap = 2500
    segmentation_model_dir = "/hpcnfs/scratch/P_DIMA_ATTEND/models/"
    segmentation_model = "stardist_full_e200_lr00001_aug1_seed10_es50p0.001_rlr0.5p50"

    // Stacking and metadata.
    pixel_microns = 0.325

    // Activate test configuration.
    test = false
    executor = 'slurm'

    // Backwards-compatible / existing defaults (keep some previously-set params).
    preproc_normalize = true
    preproc_tile_size = 512
    preproc_pool_workers = 4
    seg_model = 'cellpose'
    seg_gpu = true
    threads = 4
    quant_gpu = false
}

// Per-stage container images (can be overridden via CLI e.g. --container.preprocess 'repo/image:tag')
params.container = [
    preprocess: 'docker.io/library/python:3.9-slim',
    registration: 'docker.io/library/python:3.9-slim',
    segmentation: 'docker.io/ateia/segment:latest',
    quantification: 'docker.io/ateia/quant:latest',
    phenotyping: 'docker.io/ateia/pheno:latest'
]

// Default executor and resource defaults
process {
    executor = 'local'
    cpus = params.threads
    memory = '8 GB'
    time = '2h'
}

// Named profiles
profiles {
    // Local development
    standard {
        process.executor = 'local'
    }

    // SLURM cluster with GPU resources
    slurm {
        // This pipeline no longer ships an institutional SLURM config.
        // Add your site-specific config with `-c path/to/your_slurm.config`
    }

    // Test profile for quick local runs (use with -profile test)
    test {
        includeConfig 'conf/test.config'
    }

    // Use when GPU label is required on processes
    gpu {
        // processes can set `label 'gpu'` and this profile maps it on the cluster
    }

    // Docker profile (example)
    docker {
        process.executor = 'local'
        process.container = 'quay.io/biocontainers/python:3.8'
    }
    
    // Singularity profile used on clusters where Singularity is preferred.
    singularity {
        singularity.autoMounts = true
        singularity.enabled    = true
        charliecloud.enabled   = false
        docker.enabled         = false
        podman.enabled         = false
        shifter.enabled        = false
        process.container = "alech00/attend_image_analysis:v2.1"
    }
}

// Executor tuning.
executor {
  name = 'slurm'
  exitReadTimeout = '1000000 sec'
}

// Tower configuration (optional telemetry / monitoring endpoint).
tower{
    enabled = true
    endpoint= 'https://seqera.ieo.it/api'
}
