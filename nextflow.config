/*
========================================================================================
    ATEIA WSI Processing Pipeline - Main Configuration
========================================================================================
    Author: ateia team
    Version: 0.1.0
========================================================================================
*/

// Include modular configurations
includeConfig 'conf/base.config'
includeConfig 'conf/modules.config'

// Pipeline metadata
manifest {
    name            = 'ateia'
    description     = 'WSI processing pipeline (preprocessing, registration, segmentation, quantification, phenotyping)'
    author          = 'ateia team'
    version         = '0.1.0'
    nextflowVersion = '>=23.04.0'
}

/*
========================================================================================
    Pipeline Parameters
========================================================================================
*/

params {
    // ============================================================================
    // Input/Output
    // ============================================================================
    input       = ""              // Input glob pattern (e.g., "data/*.nd2")
    outdir      = "./results"     // Output directory

    // ============================================================================
    // SLURM Configuration
    // ============================================================================
    slurm_partition = null        // SLURM partition name (null = default)
    slurm_account   = null        // SLURM account (null = not set)
    slurm_qos       = null        // Quality of Service (null = not set)

    // ============================================================================
    // Preprocessing Parameters
    // ============================================================================
    preproc_normalize    = true
    preproc_tile_size    = 512
    preproc_skip_dapi    = true
    preproc_autotune     = false
    preproc_n_iter       = 3
    preproc_pool_workers = 4

    // ============================================================================
    // Registration Parameters
    // ============================================================================
    // No specific parameters needed - uses defaults from register.py

    // ============================================================================
    // Segmentation Parameters
    // ============================================================================
    seg_model              = 'cellpose'
    seg_gpu                = true
    seg_whole_image        = true
    seg_crop_size          = 8000
    seg_gamma              = 0.6
    segmentation_overlap   = 2500
    segmentation_model_dir = "/hpcnfs/scratch/P_DIMA_ATTEND/models/"
    segmentation_model     = "stardist_full_e200_lr00001_aug1_seed10_es50p0.001_rlr0.5p50"

    // ============================================================================
    // Quantification Parameters
    // ============================================================================
    quant_gpu      = false
    quant_min_area = 0

    // ============================================================================
    // Phenotyping Parameters
    // ============================================================================
    pheno_markers            = null   // List of markers (null = use defaults from script)
    pheno_cutoffs            = null   // Expression cutoffs (null = use defaults from script)
    pheno_quality_percentile = 1.0
    pheno_noise_percentile   = 0.01

    // ============================================================================
    // Pipeline Control
    // ============================================================================
    test = false

    // ============================================================================
    // General
    // ============================================================================
    threads = 4
}

/*
========================================================================================
    Container Images
========================================================================================
*/

params.container = [
    preprocess:     'docker.io/library/python:3.9-slim',
    registration:   'docker.io/library/python:3.9-slim',
    segmentation:   'docker.io/ateia/segment:latest',
    quantification: 'docker.io/ateia/quant:latest',
    phenotyping:    'docker.io/ateia/pheno:latest'
]

/*
========================================================================================
    Execution Profiles
========================================================================================
*/

profiles {
    // Default: SLURM execution
    standard {
        process.executor = 'slurm'
        process.queue    = params.slurm_partition

        process.clusterOptions = {
            def opts = []
            if (params.slurm_account) opts << "--account=${params.slurm_account}"
            if (params.slurm_qos)     opts << "--qos=${params.slurm_qos}"
            return opts ? opts.join(' ') : null
        }
    }

    // SLURM with Singularity containers
    slurm {
        process.executor = 'slurm'
        process.queue    = params.slurm_partition
        process.container = "alech00/attend_image_analysis:v2.1"

        singularity.enabled    = true
        singularity.autoMounts = true
        docker.enabled         = false

        process.clusterOptions = {
            def opts = []
            if (params.slurm_account) opts << "--account=${params.slurm_account}"
            if (params.slurm_qos)     opts << "--qos=${params.slurm_qos}"
            return opts ? opts.join(' ') : null
        }
    }

    // Test profile (small dataset validation)
    test {
        params.test = true
        includeConfig 'conf/test.config'
    }

    // Local development (no SLURM)
    local {
        process.executor = 'local'
        process.cpus     = 4
        process.memory   = '16.GB'
    }

    // Docker (local development with containers)
    docker {
        process.executor  = 'local'
        docker.enabled    = true
        docker.runOptions = '-u $(id -u):$(id -g)'
    }
}

/*
========================================================================================
    Nextflow Tower (optional monitoring)
========================================================================================
*/

tower {
    enabled  = true
    endpoint = 'https://seqera.ieo.it/api'
}
