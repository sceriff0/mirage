/*
========================================================================================
    Process-specific Resource Configuration
========================================================================================
    Direct SLURM resource allocation for each process
========================================================================================
*/

process {

    /*
    ================================================================================
        Resource Labels (used by processes)
    ================================================================================
    */

    withLabel: 'process_low' {
        cpus   = 1
        memory = '16.GB'
        time   = '1.h'
    }

    withLabel: 'process_medium' {
        cpus   = 2
        memory = '128.GB'
        time   = '4.h'
    }

    withLabel: 'process_high' {
        cpus   = 3
        memory = '256.GB'
        time   = '8.h'
    }

    withLabel: 'gpu' {
        clusterOptions = '--gres=gpu:1'
        containerOptions = '--nv'  // Enable NVIDIA GPU support in Singularity
    }

    /*
    ================================================================================
        Pipeline Processes
    ================================================================================
    */

    withName: CONVERT_ND2 {
        cpus   = 4
        memory = '128.GB'
        time   = '1.h'
    }

    withName: 'PREPROCESS' {
        cpus   = 4
        memory = '256.GB'
        time   = '3.h'
    }

    withName: 'REGISTER' {
        cpus   = 16
        memory = '512.GB'
        time   = '24.h'
    }
/*
    withName: 'GPU_REGISTER' {
        // Dynamic resources defined in process (based on file size)
        // Memory: Small (<10GB) = 128GB, Medium (10-30GB) = 256GB, Large (>30GB) = 388GB
        // Time: Small = 2h, Medium = 3h, Large = 4h
        // CPU and GPU allocation handled in process definition
    }
*/
    withName: 'MERGE' {
        cpus   = 4
        memory = '512.GB'
        time   = '8.h'
    }

    withName: 'SEGMENT' {
        cpus   = 8
        memory = '256.GB'
        time   = '1.h'
        // Automatically adds GPU based on params.seg_gpu
        clusterOptions = { params.seg_gpu ? '--gres=gpu:1' : '' }
    }

    withName: 'CLASSIFY' {
        cpus   = 4
        memory = '256.GB'
        time   = '3.h'
        // Automatically adds GPU based on params.classify_gpu
        clusterOptions = { params.classify_gpu ? '--gres=gpu:1' : '' }
    }

    withName: 'QUANTIFY' {
        cpus   = 8
        memory = '256.GB'
        time   = '6.h'
        // Automatically adds GPU based on params.quant_gpu
        clusterOptions = { params.quant_gpu ? '--gres=gpu:1' : '' }
    }

    withName: 'PHENOTYPE' {
        cpus   = 4
        memory = '16.GB'
        time   = '2.h'
    }
}

