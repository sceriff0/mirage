nextflow_pipeline {

    name "Test full ATEIA pipeline"
    script "main.nf"

    tag "pipeline"
    tag "pipeline_ateia"

    test("Should run preprocessing with test profile - stub mode") {

        options "-stub"

        when {
            params {
                input = "$projectDir/tests/testdata/test_input.csv"
                outdir = "$outputDir"
                step = "preprocessing"
                skip_nd2_conversion = true  // Use OME-TIFF directly

                // Minimal resources
                max_cpus = 2
                max_memory = '6.GB'
                max_time = '1.h'

                // Disable GPU for testing
                seg_gpu = false
                quant_gpu = false
                gpu_register = false

                // Reduce computational load
                preproc_tile_size = 256
                preproc_n_iter = 1
                seg_n_tiles_y = 2
                seg_n_tiles_x = 2
            }
        }

        then {
            assert workflow.success
            assert path("$outputDir").exists()

            // Check that some expected outputs exist
            // In stub mode, files will be empty placeholders
            assert workflow.trace.succeeded().size() > 0
        }
    }

    test("Should run with test profile - full preprocessing") {

        when {
            params {
                input = "$projectDir/tests/testdata/test_input.csv"
                outdir = "$outputDir"
                step = "preprocessing"
                skip_nd2_conversion = true

                // Test profile settings
                max_cpus = 2
                max_memory = '6.GB'
                max_time = '1.h'

                seg_gpu = false
                quant_gpu = false
                gpu_register = false

                preproc_tile_size = 256
                preproc_n_iter = 1
            }
        }

        then {
            assert workflow.success

            // Verify checkpoint CSV was created
            assert path("$outputDir/checkpoint_csvs/preprocessing_checkpoint.csv").exists()

            // Verify preprocessed images exist
            def preprocessed = path("$outputDir").list()
            assert preprocessed.size() > 0
        }
    }

    test("Should validate parameters correctly") {

        when {
            params {
                input = "$projectDir/tests/testdata/test_input.csv"
                outdir = "$outputDir"
                step = "preprocessing"

                // Parameter validation should run
                help = false
            }
        }

        then {
            // Should complete parameter validation without error
            assert workflow.success || workflow.failed

            // If it fails, it should be due to missing dependencies, not validation
            if (workflow.failed) {
                assert workflow.errorMessage != null
            }
        }
    }

    test("Should handle checkpoint CSV for registration step") {

        options "-stub"

        when {
            params {
                input = "$projectDir/tests/testdata/valid_checkpoint_registration.csv"
                outdir = "$outputDir"
                step = "registration"

                max_cpus = 2
                max_memory = '6.GB'

                gpu_register = false
                skip_registration_qc = true
            }
        }

        then {
            // Should accept checkpoint CSV and start from registration
            assert workflow.success
        }
    }
}
