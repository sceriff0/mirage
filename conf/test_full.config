/*
========================================================================================
    Test Full Profile Configuration - nf-core Compliant
========================================================================================
    Full-size test dataset for comprehensive pipeline validation
    Reference: https://nf-co.re/docs/guidelines/pipelines/recommendations/testing
========================================================================================
*/

params {
    config_profile_name        = 'Full test profile'
    config_profile_description = 'Full-size test dataset to check pipeline function'

    // Higher resource limits for comprehensive testing
    max_cpus   = 8
    max_memory = '32.GB'
    max_time   = '6.h'

    // Test input data - multi-patient
    input  = "${projectDir}/tests/testdata/valid_preprocessing.csv"
    outdir = "test_results_full"

    // Pipeline step
    step = 'preprocessing'

    // Test with GPU if available (will fallback to CPU if not)
    seg_gpu = false  // Set to true if GPU available

    // Normal computational parameters
    preproc_tile_size         = 1024
    preproc_n_iter            = 3
    preproc_pool_workers      = 4

    // Registration parameters - realistic
    registration_method       = 'valis'
    padding                   = true  // Test padding workflow
    memory_mode               = 'high'   // Use high memory mode for realistic testing
    feature_max_dim           = 2048
    feature_n_features        = 5000

    // GPU registration parameters
    gpu_reg_affine_crop_size  = 10000
    gpu_reg_diffeo_crop_size  = 2000

    // CPU registration parameters
    cpu_reg_affine_crop_size  = 10000
    cpu_reg_diffeo_crop_size  = 2000

    // Segmentation parameters
    seg_n_tiles_y             = 4
    seg_n_tiles_x             = 4

    // QC generation (full resolution)
    skip_registration_qc      = false
    qc_scale_factor           = 0.25

    // Error estimation (enabled for validation)
    enable_feature_error      = true

    savedir                   = null
    debug_channels            = false
}

process {
    executor = 'local'

    // Default resources
    cpus   = { check_max( 2 * task.attempt, 'cpus' ) }
    memory = { check_max( 8.GB * task.attempt, 'memory' ) }
    time   = { check_max( 2.h  * task.attempt, 'time' ) }

    // Resource labels
    withLabel: 'process_single' {
        cpus   = 1
        memory = 4.GB
        time   = 1.h
    }

    withLabel: 'process_low' {
        cpus   = 2
        memory = 8.GB
        time   = 2.h
    }

    withLabel: 'process_medium' {
        cpus   = 4
        memory = 16.GB
        time   = 4.h
    }

    withLabel: 'process_high' {
        cpus   = 8
        memory = 32.GB
        time   = 6.h
    }

    withLabel: 'gpu' {
        cpus   = 4
        memory = 16.GB
        time   = 4.h
    }

    // Error handling with retries
    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries    = 2
    maxErrors     = '-1'
}

// Enable Docker for reproducibility
docker {
    enabled = true
    runOptions = '-u $(id -u):$(id -g)'
}
