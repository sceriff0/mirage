/*
========================================================================================
    nf-test Configuration - nf-core Compliant
========================================================================================
    Configuration for nf-test framework
    References:
    - https://www.nf-test.com/docs/configuration/
    - https://nf-co.re/docs/contributing/nf-test/assertions
========================================================================================
*/

config {
    // Location for nf-test temporary files
    workDir = ".nf-test"

    // Test output directory
    testsDir = "tests"

    // Default test profile (can be overridden with -profile)
    profile = "test,docker"

    // Test options
    options {
        // Fail on first failed test
        failFast = false

        // Run tests in parallel
        parallel = true

        // Number of parallel threads (adjust based on system)
        threads = 4

        // Verbose output
        verbose = false

        // Silent mode (only show failures)
        silent = false
    }

    // Snapshot configuration
    snapshot {
        // Automatically update snapshots when running with --update
        update = false

        // Create snapshots if they don't exist
        create = true
    }

    // Stage configuration - files to copy to test workspace
    stage {
        copy = [
            "modules/",
            "subworkflows/",
            "lib/",
            "bin/",
            "conf/",
            "assets/",
            "main.nf",
            "nextflow.config",
            "nextflow_schema.json"
        ]
    }
}

// Test profiles
profiles {
    // Minimal test profile - fast CI tests
    test {
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g)'

        params.max_cpus = 2
        params.max_memory = '6.GB'
        params.max_time = '1.h'
    }

    // Full test profile - comprehensive validation
    test_full {
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g)'

        params.max_cpus = 8
        params.max_memory = '32.GB'
        params.max_time = '6.h'
    }

    // Stub mode for fast structural testing
    stub {
        docker.enabled = false
        params.stub_run = true
    }

    // Docker profile
    docker {
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g)'

        singularity.enabled = false
        conda.enabled = false
    }

    // Singularity for HPC environments
    singularity {
        singularity.enabled = true
        singularity.autoMounts = true

        docker.enabled = false
        conda.enabled = false
    }

    // Conda environment testing
    conda {
        conda.enabled = true
        conda.useMamba = true

        docker.enabled = false
        singularity.enabled = false
    }

    // Debug profile - verbose output
    debug {
        docker.enabled = true

        process.beforeScript = 'echo $HOSTNAME'
        cleanup = false

        options.verbose = true
    }

    // Local profile for development (no containers)
    local {
        docker.enabled = false
        singularity.enabled = false
        conda.enabled = false

        process.executor = 'local'
    }

    // SLURM profile for HPC clusters
    slurm {
        process.executor = 'slurm'
        process.queue = 'normal'  // Adjust to your partition name
        process.clusterOptions = '--account=your_account'  // Adjust if needed

        singularity.enabled = true
        singularity.autoMounts = true

        docker.enabled = false
        conda.enabled = false

        params.max_cpus = 16
        params.max_memory = '64.GB'
        params.max_time = '4.h'
    }
}

// Manifest metadata
manifest {
    name = 'ateia'
    homePage = 'https://github.com/your-org/ateia'
    description = 'WSI processing pipeline testing configuration'
    version = '1.0.0'
}
