// Include shared configs used by nf-core-style pipelines
includeConfig 'conf/base.config'
includeConfig 'conf/modules.config'

manifest {
    name = 'ateia'
    description = 'WSI processing pipeline (preprocessing, registration, segmentation, quantification, phenotyping)'
    author = 'ateia team'
    version = '0.1.0'
}

// Default parameters (can be overridden on the CLI)
params {
    // User input parameters.
    input = ""
    outdir = "./results"
    debug_dir = ""
    log_file = ""
    use_gpu = true

    // SLURM execution settings
    slurm_partition = null  // Use default partition, or set to specific partition name
    slurm_account   = null  // Set your SLURM account if required
    slurm_qos       = null  // Quality of Service if your cluster uses it

    // Debug mode.
    debug = true

    // Optional channels.
    optional_channels = ""
    
    preprocessing = true
    conversion = false
    
    // Conversion / preprocessing crop parameters.
    crop_size_preproc = 4096
    overlap_size_preproc = 4000
    crop_size_affine = 10000
    overlap_size_affine = 4000
    crop_size_diffeo = 2000
    overlap_size_diffeo = 800
    downscale_factor = 1
    n_crops = 4

    // Image conversion.
    tilex = 512
    tiley = 512
    pyramid_resolutions = 3
    pyramid_scale = 2
    compression = 'lzw'  // Options: 'lzw', 'jpeg', 'deflate', 'none'
    jpeg_quality = 90    // JPEG quality (1-100), only used if compression='jpeg'

    // Segmentation.
    segmentation_overlap = 2500
    segmentation_model_dir = "/hpcnfs/scratch/P_DIMA_ATTEND/models/"
    segmentation_model = "stardist_full_e200_lr00001_aug1_seed10_es50p0.001_rlr0.5p50"

    // Stacking and metadata.
    pixel_microns = 0.325

    // Activate test configuration.
    test = false
    executor = 'slurm'

    // Preprocessing parameters
    preproc_normalize = true
    preproc_tile_size = 512
    preproc_skip_dapi = true
    preproc_autotune = false
    preproc_n_iter = 3
    preproc_pool_workers = 4

    // Segmentation parameters
    seg_model = 'cellpose'
    seg_gpu = true
    seg_whole_image = true
    seg_crop_size = 8000
    seg_gamma = 0.6

    // Quantification parameters
    quant_gpu = false
    quant_min_area = 0

    // Phenotyping parameters
    pheno_markers = null  // Use defaults from phenotype.py if null
    pheno_cutoffs = null  // Use defaults from phenotype.py if null
    pheno_quality_percentile = 1.0
    pheno_noise_percentile = 0.01

    // General parameters
    threads = 4
}

// Per-stage container images (can be overridden via CLI e.g. --container.preprocess 'repo/image:tag')
params.container = [
    preprocess: 'docker.io/library/python:3.9-slim',
    registration: 'docker.io/library/python:3.9-slim',
    segmentation: 'docker.io/ateia/segment:latest',
    quantification: 'docker.io/ateia/quant:latest',
    phenotyping: 'docker.io/ateia/pheno:latest'
]

// Default executor and resource defaults
process {
    executor = 'local'
    cpus = params.threads
    memory = '8 GB'
    time = '2h'
}

// Named profiles
profiles {
    // Default SLURM profile
    standard {
        process.executor = 'slurm'
        process.queue = params.slurm_partition
        process.clusterOptions = {
            def opts = []
            if (params.slurm_account) opts << "--account=${params.slurm_account}"
            if (params.slurm_qos) opts << "--qos=${params.slurm_qos}"
            return opts ? opts.join(' ') : null
        }
    }

    // SLURM with Singularity containers
    slurm {
        process.executor = 'slurm'
        process.queue = params.slurm_partition
        singularity.enabled = true
        singularity.autoMounts = true
        docker.enabled = false
        process.container = "alech00/attend_image_analysis:v2.1"
        process.clusterOptions = {
            def opts = []
            if (params.slurm_account) opts << "--account=${params.slurm_account}"
            if (params.slurm_qos) opts << "--qos=${params.slurm_qos}"
            return opts ? opts.join(' ') : null
        }
    }

    // Test profile for quick validation runs
    test {
        includeConfig 'conf/test.config'
        params.test = true
    }

    // Local development (for testing without SLURM)
    local {
        process.executor = 'local'
        process.cpus = 4
        process.memory = '16.GB'
    }

    // Docker profile for local development
    docker {
        process.executor = 'local'
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g)'
    }
}

// This is now handled in conf/base.config

// Tower configuration (optional telemetry / monitoring endpoint).
tower{
    enabled = true
    endpoint= 'https://seqera.ieo.it/api'
}
