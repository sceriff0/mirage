/*
========================================================================================
    ATEIA WSI Processing Pipeline - Main Configuration
========================================================================================
    Author: ateia team
    Version: 0.1.0
========================================================================================
*/

// Include modular configurations
includeConfig 'conf/base.config'
includeConfig 'conf/modules.config'

// Pipeline metadata
manifest {
    name            = 'ateia'
    description     = 'WSI processing pipeline (preprocessing, registration, segmentation, quantification, phenotyping)'
    author          = 'ateia team'
    version         = '0.1.0'
    nextflowVersion = '>=23.04.0'
}

/*
========================================================================================
    Pipeline Parameters
========================================================================================
*/

params {
    // ============================================================================
    // Input/Output
    // ============================================================================
    input       = ""              // Input glob pattern (e.g., "data/*.nd2")
    outdir      = "./results"     // Output directory
    savedir     = "/hpcnfs/techunits/imaging/work/ATTEND/full_analysis"
    id          = null            // Sample ID

    // ============================================================================
    // SLURM Configuration
    // ============================================================================
    slurm_partition = null        // SLURM partition name (null = default)
    slurm_account   = null        // SLURM account (null = not set)
    slurm_qos       = null        // Quality of Service (null = not set)

    // ============================================================================
    // Preprocessing Parameters
    // ============================================================================
    preproc_normalize    = true
    preproc_tile_size    = 1950
    preproc_skip_dapi    = true
    preproc_autotune     = false
    preproc_n_iter       = 3
    preproc_pool_workers = 4
    preproc_overlap      = 0                 // Overlap between FOV tiles for BaSiC
    preproc_no_darkfield = false             // Disable darkfield estimation

    // ============================================================================
    // Registration Parameters
    // ============================================================================
    registration_method       = 'gpu'       // Registration method: 'classic' or 'gpu'

    // Classic registration (VALIS)
    reg_reference_markers     = ['DAPI', 'SMA']  // Markers to identify reference image
    reg_max_processed_dim     = 850            // Maximum image dimension for rigid registration
    reg_max_non_rigid_dim     = 2048           // Maximum dimension for non-rigid registration
    reg_micro_reg_fraction    = 0.25           // Fraction of image size for micro-registration
    reg_num_features          = 2000           // Number of SuperPoint features to detect

    // GPU registration (affine + diffeomorphic)
    gpu_reg_affine_crop_size  = 10000           // Size of crops for affine registration stage
    gpu_reg_diffeo_crop_size  = 2000           // Size of crops for diffeomorphic registration stage
    gpu_reg_overlap_percent   = 20.0           // Overlap between crops as percentage (default: 10%, recommended: 10-20%)
    gpu_reg_n_features        = 2000           // Number of ORB features for affine registration
    gpu_reg_n_workers         = 8              // Number of parallel CPU workers per GPU process
    gpu_reg_opt_tol           = 1e-5           // Diffeomorphic optimization tolerance (default: 1e-5, recommended: 1e-5 to 1e-7)
    gpu_reg_inv_tol           = 1e-5           // Diffeomorphic inverse tolerance (default: 1e-5)
    gpu_reg_pad_mode          = 'constant'     // Padding mode: 'constant' (zeros), 'edge', 'reflect', 'symmetric'

    // CPU registration (affine + diffeomorphic, multi-threaded)
    cpu_reg_affine_crop_size  = 8000           // Size of crops for affine registration stage
    cpu_reg_diffeo_crop_size  = 2000           // Size of crops for diffeomorphic registration stage (smaller for CPU)
    cpu_reg_overlap_percent   = 20.0           // Overlap between crops as percentage (default: 10%, recommended: 10-20%)
    cpu_reg_n_features        = 2000           // Number of ORB features for affine registration
    cpu_reg_opt_tol           = 1e-5           // Diffeomorphic optimization tolerance (default: 1e-5, recommended: 1e-5 to 1e-7)
    cpu_reg_inv_tol           = 1e-5           // Diffeomorphic inverse tolerance (default: 1e-5)
    cpu_reg_pad_mode          = 'constant'     // Padding mode: 'constant' (zeros), 'edge', 'reflect', 'symmetric'

    // ============================================================================
    // Segmentation Parameters
    // ============================================================================
    seg_model              = 'cellpose'
    seg_gpu                = true
    seg_whole_image        = true
    seg_crop_size          = 8000
    seg_gamma              = 0.6
    seg_tophat_radius      = 50                // Top-hat morphological filter radius
    seg_gaussian_sigma     = 1.0               // Gaussian filter sigma for smoothing
    seg_pmin               = 1.0               // Normalization lower percentile
    seg_pmax               = 99.8              // Normalization upper percentile
    segmentation_overlap   = 2500
    segmentation_model_dir = "/hpcnfs/scratch/P_DIMA_ATTEND/models/"
    segmentation_model     = "stardist_full_e200_lr00001_aug1_seed10_es50p0.001_rlr0.5p50"

    // ============================================================================
    // Cell Classification Method
    // ============================================================================
    classification_method = 'classic'                    // 'classic' (deepcell-types) or 'quantify' (quantify + phenotype)

    // ============================================================================
    // Cell Classification Parameters (deepcell-types) - for 'classic' method
    // ============================================================================
    classify_gpu         = true                          // Use GPU for classification
    classify_model       = 'deepcell-types_2025-06-09'   // DeepCell Types model name
    classify_num_workers = 4                             // Number of data loader threads
    pixel_size           = 0.325                         // Pixel size in microns

    // ============================================================================
    // Quantification Parameters - for 'quantify' method
    // ============================================================================
    quant_gpu            = true                          // Use GPU for quantification
    quant_min_area       = 10                            // Minimum cell area (pixels)

    // ============================================================================
    // Phenotyping Parameters - for 'quantify' method
    // ============================================================================
    pheno_markers            = []                        // Markers to use for phenotyping (empty = all)
    pheno_cutoffs            = []                        // Custom cutoffs for markers
    pheno_quality_percentile = 95                        // Quality control percentile
    pheno_noise_percentile   = 5                         // Noise threshold percentile

    // ============================================================================
    // Pipeline Control
    // ============================================================================
    test = false

    // ============================================================================
    // General
    // ============================================================================
    threads = 4
}

/*
========================================================================================
    Container Images
========================================================================================
*/

params.container = [
    preprocess:     'docker://alech00/attend_image_analysis:v2.1',
    registration:   'docker://cdgatenbee/valis-wsi:1.0.0',
    register_gpu:   'docker://bolt3x/attend_image_analysis:debug_diffeo',  // GPU registration
    merge:          'docker://bolt3x/attend_image_analysis:merge',
    segmentation:   'docker://bolt3x/attend_image_analysis:segmentation_gpu',
    classify:       'docker://bolt3x/attend_image_analysis:deep_cell_types',
    quantification: 'docker://bolt3x/attend_image_analysis:quantification_gpu',
    phenotyping:    'docker://yinxiu/attend_seg:v0.0"'
]

/*
========================================================================================
    Execution Profiles
========================================================================================
*/

profiles {
    // Default: SLURM execution with Singularity containers
    standard {
        process.executor = 'slurm'
        process.queue    = params.slurm_partition
        process.container = "alech00/attend_image_analysis:v2.1"

        singularity.enabled    = true
        singularity.autoMounts = true
        singularity.runOptions = '--bind /hpcnfs/scratch/P_DIMA_ATTEND/models --bind /hpcnfs/home/ieo7660/.deepcell/models --bind /hpcnfs/home/ieo7660/.cupy'
        docker.enabled         = false

        process.clusterOptions = {
            def opts = []
            if (params.slurm_account && params.slurm_account != '') opts << "--account=${params.slurm_account}"
            if (params.slurm_qos && params.slurm_qos != '')         opts << "--qos=${params.slurm_qos}"
            return opts ? opts.join(' ') : null
        }
    }

    // SLURM with Singularity containers (alias for standard)
    slurm {
        process.executor = 'slurm'
        process.queue    = params.slurm_partition
        process.container = "alech00/attend_image_analysis:v2.1"

        singularity.enabled    = true
        singularity.autoMounts = true
        singularity.runOptions = '--bind /hpcnfs/scratch/P_DIMA_ATTEND/models --bind /hpcnfs/home/ieo7660/.deepcell/models'
        docker.enabled         = false

        process.clusterOptions = {
            def opts = []
            if (params.slurm_account && params.slurm_account != '') opts << "--account=${params.slurm_account}"
            if (params.slurm_qos && params.slurm_qos != '')         opts << "--qos=${params.slurm_qos}"
            return opts ? opts.join(' ') : null
        }
    }

    // Test profile (small dataset validation)
    test {
        params.test = true
        includeConfig 'conf/test.config'
    }

    // Local development (no SLURM)
    local {
        process.executor = 'local'
        process.cpus     = 4
        process.memory   = '16.GB'
    }

    // Docker (local development with containers)
    docker {
        process.executor  = 'local'
        docker.enabled    = true
        docker.runOptions = '-u $(id -u):$(id -g)'
    }
}

/*
========================================================================================
    Nextflow Tower (optional monitoring)
========================================================================================
*/

tower {
    workspaceId = '61664385669434'
    enabled  = true
    endpoint = 'https://seqera.ieo.it/api'
}
