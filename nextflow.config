/*
========================================================================================
    ATEIA WSI Processing Pipeline - Main Configuration
========================================================================================
    Author: ateia team
    Version: 0.1.0
========================================================================================
*/

// Include modular configurations
includeConfig 'conf/base.config'
includeConfig 'conf/modules.config'

// Pipeline metadata
manifest {
    name            = 'ateia'
    description     = 'WSI processing pipeline (preprocessing, registration, segmentation, quantification, phenotyping)'
    author          = 'ateia team'
    version         = '0.1.0'
    nextflowVersion = '>=23.04.0'
}

/*
========================================================================================
    Pipeline Parameters
========================================================================================
*/

params {
    // ============================================================================
    // Input/Output
    // ============================================================================
    input       = ""              // Input glob pattern (e.g., "data/*.nd2")
    outdir      = "./results"     // Output directory
    savedir     = "/hpcnfs/techunits/imaging/work/ATTEND/full_analysis"
    id          = null            // Sample ID

    // ============================================================================
    // SLURM Configuration
    // ============================================================================
    slurm_partition = null        // SLURM partition name (null = default)
    slurm_account   = null        // SLURM account (null = not set)
    slurm_qos       = null        // Quality of Service (null = not set)

    // ============================================================================
    // Preprocessing Parameters
    // ============================================================================
    skip_nd2_conversion  = false      // Skip ND2 conversion (set true if using TIFF input)
    preproc_normalize    = true
    preproc_tile_size    = 1950
    preproc_skip_dapi    = true
    preproc_autotune     = false
    preproc_n_iter       = 3
    preproc_pool_workers = 4
    preproc_overlap      = 0                 // Overlap between FOV tiles for BaSiC
    preproc_no_darkfield = false             // Disable darkfield estimation

    // ============================================================================
    // Registration Parameters
    // ============================================================================
    registration_method       = 'gpu'       // Registration method: 'classic' or 'gpu'

    // Classic registration (VALIS)
    reg_reference_markers     = ['DAPI', 'SMA']  // Markers to identify reference image
    reg_max_processed_dim     = 512            // Maximum image dimension for rigid registration
    reg_max_non_rigid_dim     = 2048           // Maximum dimension for non-rigid registration
    reg_micro_reg_fraction    = 0.125           // Fraction of image size for micro-registration
    reg_num_features          = 2000           // Number of SuperPoint features to detect

    // Feature detection and error estimation (for all registration methods)
    feature_detector          = 'superpoint'   // Feature detector: 'superpoint', 'disk', 'dedode', or 'brisk'
    feature_max_dim           = 2048           // Maximum image dimension for feature detection
    feature_n_features        = 5000           // Number of features to keep for matching

    // GPU registration (affine + diffeomorphic)
    gpu_reg_affine_crop_size  = 10000           // Size of crops for affine registration stage
    gpu_reg_diffeo_crop_size  = 2000           // Size of crops for diffeomorphic registration stage
    gpu_reg_overlap_percent   = 40.0           // Overlap between crops as percentage (larger overlap with linear blending to reduce tile artifacts)
    gpu_reg_n_features        = 5000           // Number of ORB features for affine registration
    gpu_reg_n_workers         = 8              // Number of parallel CPU workers per GPU process
    gpu_reg_opt_tol           = 1e-5           // Diffeomorphic optimization tolerance (default: 1e-5, recommended: 1e-5 to 1e-7)
    gpu_reg_inv_tol           = 1e-5           // Diffeomorphic inverse tolerance (default: 1e-5)
    gpu_reg_pad_mode          = 'constant'     // Padding mode: 'constant' (zeros), 'edge', 'reflect', 'symmetric'

    // CPU registration (affine + diffeomorphic, multi-threaded)
    cpu_reg_affine_crop_size  = 10000           // Size of crops for affine registration stage
    cpu_reg_diffeo_crop_size  = 2000           // Size of crops for diffeomorphic registration stage (smaller for CPU)
    cpu_reg_overlap_percent   = 40.0           // Overlap between crops as percentage (larger overlap with linear blending to reduce tile artifacts)
    cpu_reg_n_features        = 5000           // Number of ORB features for affine registration
    cpu_reg_opt_tol           = 1e-6           // Diffeomorphic optimization tolerance (default: 1e-5, recommended: 1e-5 to 1e-7)
    cpu_reg_inv_tol           = 1e-6           // Diffeomorphic inverse tolerance (default: 1e-5)
    cpu_reg_pad_mode          = 'constant'     // Padding mode: 'constant' (zeros), 'edge', 'reflect', 'symmetric'

    // ============================================================================
    // Multi-Resolution CPU Registration (coarse-to-fine strategy)
    // ============================================================================
    // Three-stage registration for maximum accuracy:
    // Stage 1: Coarse Affine - Large crops, fewer features → rough global alignment
    // Stage 2: Fine Affine - Medium crops, many features → precise global alignment
    // Stage 3: Diffeomorphic - Optimal crops → local deformations

    // PRESET: BALANCED (recommended for most use cases)
    cpu_multires_coarse_crop_size = 10000        // Coarse affine crop size
    cpu_multires_coarse_overlap_percent = 10.0  // Coarse affine overlap
    cpu_multires_coarse_n_features = 2000       // Coarse affine features (fewer for speed)

    cpu_multires_fine_crop_size = 5000          // Fine affine crop size
    cpu_multires_fine_overlap_percent = 15.0    // Fine affine overlap
    cpu_multires_fine_n_features = 5000         // Fine affine features (many for precision)

    cpu_multires_diffeo_crop_size = 2000        // Diffeomorphic crop size
    cpu_multires_diffeo_overlap_percent = 20.0  // Diffeomorphic overlap (higher for smooth blending)
    cpu_multires_diffeo_sigma_diff = 20         // Gaussian smoothing sigma (lower = less smoothing)
    cpu_multires_diffeo_radius = 20             // Neighborhood radius (higher = smoother)
    cpu_multires_opt_tol = 1e-6                 // Optimization tolerance (lower = tighter convergence)
    cpu_multires_inv_tol = 1e-6                 // Inverse tolerance

    // Additional presets (uncomment to use):

    // HIGH ACCURACY PRESET (slower, more accurate):
    // cpu_multires_coarse_crop_size = 5000
    // cpu_multires_coarse_n_features = 1500
    // cpu_multires_fine_crop_size = 3000
    // cpu_multires_fine_n_features = 7000
    // cpu_multires_diffeo_crop_size = 2500
    // cpu_multires_diffeo_overlap_percent = 20.0
    // cpu_multires_diffeo_sigma_diff = 18
    // cpu_multires_diffeo_radius = 22
    // cpu_multires_opt_tol = 1e-7
    // cpu_multires_inv_tol = 1e-7

    // FAST PRESET (faster, less accurate):
    // cpu_multires_coarse_crop_size = 3000
    // cpu_multires_coarse_n_features = 800
    // cpu_multires_fine_crop_size = 2000
    // cpu_multires_fine_n_features = 3000
    // cpu_multires_diffeo_crop_size = 1500
    // cpu_multires_diffeo_overlap_percent = 10.0
    // cpu_multires_opt_tol = 1e-5
    // cpu_multires_inv_tol = 1e-5

    // ============================================================================
    // CDM CPU Registration (Coarse-Diffeo-Micro strategy)
    // ============================================================================
    // Alternative three-stage registration optimized for non-linear deformations:
    // Stage 1: Coarse Affine - Large crops, fewer features → rough global alignment
    // Stage 2: Diffeomorphic - Standard crops → primary non-linear registration
    // Stage 3: Micro Affine - Small crops, many features → fine-tune local alignment
    //
    // Use when:
    // - Primary deformations are non-linear
    // - Need fine local detail refinement after warping
    // - Want both large-scale warping and small-scale alignment

    // PRESET: BALANCED (recommended for most cases)
    cpu_cdm_coarse_crop_size = 10000            // Coarse affine crop size (large for global features)
    cpu_cdm_coarse_overlap_percent = 10.0       // Coarse affine overlap
    cpu_cdm_coarse_n_features = 2000            // Coarse affine features

    cpu_cdm_diffeo_crop_size = 2000             // Diffeomorphic crop size
    cpu_cdm_diffeo_overlap_percent = 20.0       // Diffeomorphic overlap (higher for smooth blending)
    cpu_cdm_diffeo_sigma_diff = 20              // Gaussian smoothing sigma
    cpu_cdm_diffeo_radius = 20                  // Neighborhood radius
    cpu_cdm_diffeo_opt_tol = 1e-6               // Optimization tolerance
    cpu_cdm_diffeo_inv_tol = 1e-6               // Inverse tolerance

    cpu_cdm_micro_crop_size = 1000              // Micro affine crop size (small for local refinement)
    cpu_cdm_micro_overlap_percent = 20.0        // Micro affine overlap (high for smooth blending)
    cpu_cdm_micro_n_features = 5000             // Micro affine features (many for precision)

    // Alternative presets (uncomment to use):

    // HIGH ACCURACY PRESET:
    // cpu_cdm_coarse_crop_size = 12000
    // cpu_cdm_coarse_n_features = 3000
    // cpu_cdm_diffeo_crop_size = 2500
    // cpu_cdm_diffeo_overlap_percent = 25.0
    // cpu_cdm_diffeo_sigma_diff = 18
    // cpu_cdm_diffeo_radius = 22
    // cpu_cdm_diffeo_opt_tol = 1e-7
    // cpu_cdm_diffeo_inv_tol = 1e-7
    // cpu_cdm_micro_crop_size = 800
    // cpu_cdm_micro_n_features = 7000

    // FAST PRESET:
    // cpu_cdm_coarse_crop_size = 8000
    // cpu_cdm_coarse_n_features = 1500
    // cpu_cdm_diffeo_crop_size = 1500
    // cpu_cdm_diffeo_overlap_percent = 15.0
    // cpu_cdm_diffeo_opt_tol = 1e-5
    // cpu_cdm_micro_crop_size = 1200
    // cpu_cdm_micro_n_features = 3000

    // ============================================================================
    // Segmentation Parameters
    // ============================================================================
    seg_model              = 'cellpose'
    seg_gpu                = true
    seg_whole_image        = true
    seg_crop_size          = 8000
    seg_gamma              = 0.6
    seg_tophat_radius      = 50                // Top-hat morphological filter radius
    seg_gaussian_sigma     = 1.0               // Gaussian filter sigma for smoothing
    seg_pmin               = 1.0               // Normalization lower percentile
    seg_pmax               = 99.8              // Normalization upper percentile
    segmentation_overlap   = 2500
    segmentation_model_dir = "/hpcnfs/scratch/P_DIMA_ATTEND/models/"
    segmentation_model     = "stardist_full_e200_lr00001_aug1_seed10_es50p0.001_rlr0.5p50"

    // ============================================================================
    // Cell Classification Method
    // ============================================================================
    classification_method = 'classic'                    // 'classic' (deepcell-types) or 'quantify' (quantify + phenotype)

    // ============================================================================
    // Cell Classification Parameters (deepcell-types) - for 'classic' method
    // ============================================================================
    classify_gpu         = true                          // Use GPU for classification
    classify_model       = 'deepcell-types_2025-06-09'   // DeepCell Types model name
    classify_num_workers = 4                             // Number of data loader threads
    pixel_size           = 0.325                         // Pixel size in microns

    // ============================================================================
    // Quantification Parameters - for 'quantify' method
    // ============================================================================
    quant_gpu            = true                          // Use GPU for quantification
    quant_min_area       = 10                            // Minimum cell area (pixels)

    // ============================================================================
    // Phenotyping Parameters - for 'quantify' method
    // ============================================================================
    pheno_markers            = []                        // Markers to use for phenotyping (empty = all)
    pheno_cutoffs            = []                        // Custom cutoffs for markers
    pheno_quality_percentile = 95                        // Quality control percentile
    pheno_noise_percentile   = 5                         // Noise threshold percentile

    // ============================================================================
    // Pipeline Control
    // ============================================================================
    test = false

    // ============================================================================
    // General
    // ============================================================================
    threads = 4
}

/*
========================================================================================
    Container Images
========================================================================================
*/

params.container = [
    preprocess:     'docker://bolt3x/attend_image_analysis:preprocess',
    registration:   'docker://cdgatenbee/valis-wsi:1.0.0',
    register_gpu:   'docker://bolt3x/attend_image_analysis:debug_diffeo',  // GPU registration
    merge:          'docker://bolt3x/attend_image_analysis:merge',
    segmentation:   'docker://bolt3x/attend_image_analysis:segmentation_gpu',
    classify:       'docker://bolt3x/attend_image_analysis:deep_cell_types',
    quantification: 'docker://bolt3x/attend_image_analysis:quantification_gpu'
]

/*
========================================================================================
    Execution Profiles
========================================================================================
*/

profiles {
    // Default: SLURM execution with Singularity containers
    standard {
        process.executor = 'slurm'
        process.queue    = params.slurm_partition
        process.container = "alech00/attend_image_analysis:v2.1"

        singularity.enabled    = true
        singularity.autoMounts = true
        singularity.runOptions = '--bind /hpcnfs/scratch/P_DIMA_ATTEND/models --bind /hpcnfs/home/ieo7660/.deepcell/models --bind /hpcnfs/home/ieo7660/.cupy'
        docker.enabled         = false

        process.clusterOptions = {
            def opts = []
            if (params.slurm_account && params.slurm_account != '') opts << "--account=${params.slurm_account}"
            if (params.slurm_qos && params.slurm_qos != '')         opts << "--qos=${params.slurm_qos}"
            return opts ? opts.join(' ') : null
        }
    }

    // SLURM with Singularity containers (alias for standard)
    slurm {
        process.executor = 'slurm'
        process.queue    = params.slurm_partition
        process.container = "alech00/attend_image_analysis:v2.1"

        singularity.enabled    = true
        singularity.autoMounts = true
        singularity.runOptions = '--bind /hpcnfs/scratch/P_DIMA_ATTEND/models --bind /hpcnfs/home/ieo7660/.deepcell/models'
        docker.enabled         = false

        process.clusterOptions = {
            def opts = []
            if (params.slurm_account && params.slurm_account != '') opts << "--account=${params.slurm_account}"
            if (params.slurm_qos && params.slurm_qos != '')         opts << "--qos=${params.slurm_qos}"
            return opts ? opts.join(' ') : null
        }
    }

    // Test profile (small dataset validation)
    test {
        params.test = true
        includeConfig 'conf/test.config'
    }

    // Local development (no SLURM)
    local {
        process.executor = 'local'
        process.cpus     = 4
        process.memory   = '16.GB'
    }

    // Docker (local development with containers)
    docker {
        process.executor  = 'local'
        docker.enabled    = true
        docker.runOptions = '-u $(id -u):$(id -g)'
    }
}

/*
========================================================================================
    Nextflow Tower (optional monitoring)
========================================================================================
*/

tower {
    workspaceId = '61664385669434'
    enabled  = true
    endpoint = 'https://seqera.ieo.it/api'
}
